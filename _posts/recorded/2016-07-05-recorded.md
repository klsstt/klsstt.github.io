---
layout: post
title:  java工作总结（五）
date:   2016-07-05 17:27:06 +0800
categories: 日常记录
---
# java工作总结（五）

java工作总结是一个持续更新的系列，是本人对自己多年工作中使用到java的一个经验性总结，也是温故而知新吧，因为很多基础的东西过了这么多年，平时工作中用不到也会遗忘掉，所以看看书，上上网，查查资料，也算是记录下自己的笔记吧，过一段时间之后再来看看也是蛮不错的，也希望能帮助到正在学习的人们，本系列将要总结一下几点：

- **面向对象的编程思想**
- **java的基本语法**
- **一些有趣的框架解析**
- **实战项目的整体思路**
- **代码的优化以及性能调优的几种方案**
- **其它遗漏的东西以及补充**

-------------------

## 代码的优化以及性能调优的几种方案
		
还记得学生时代，在学习java的时候，经常有作业要去完成，但是我的同学们他们完成作业的代码总有一些差异，那个时候我经常看不同人的代码，每个人写代码都有自己的风格和想法，举个很简单的例子，可能A同学在判断类型（type=｛1，2，3等多个值｝）的时候是if加if来判断，B同学可能就是if加else，C同学可能就是switch了，可能还有D同学，他将每种情况都赋予不同的变量，再用不同的变量去做自己的业务，他们的代码都能最终实现需求，也都是正确的代码，这玩意其实很难界定对错，因为不同的业务情况下，每个人的思路都可能是一个亮点，也可能是一个槽点，在工作中，我们经常需要开会，需要头脑风暴，就是为了把不同的想法都列出来，选出最合适最高效的一条来。代码优化的目的就是为了性能的提升，增强代码的可维护性，容易阅读，这也算是程序性能调优的一部分。

###1.代码规范。
**目的：**提升代码的可读性

> 我们写程序，一般情况下都不可能一次就写好，写出来的代码可能后期需要重构，需要拓展，或者业务变动，人事变动等，需要去修改别人写的东西，那么肯定也会遇到各种各样的代码，晦涩难懂的，或者简介明了的，或者逻辑性非常弱并夹杂了许多冗余代码等等各种情况，有些同事喜欢复制粘贴，然后修修改改，可能他只为了要拿到一个字段，就复制了一堆东西，当然程序写完了运行起来都是对的，但是这样写的代码会导致系统的性能耗损，维护性降低，转手给别人的时候，也容易误导别人，被人鄙视。
> **我在工作中也总结了几点小规范，写在这里给大家参考参考**：
> 1. 去掉无用的引用类，由于本人使用编辑工具是eclipse，eclipse有快捷键Ctrl+Shilft+O，可以去除没有用到的类引用，经常在维护系统或者修改需求时遇到一些类中引入了大量其它东西，后面可能需求变动又没有再使用过，导致引用类没有实际用过，出现黄色警告，本人有相关强迫症，遇到警号一般都是尽力消灭，而且引用到的类都是占用一定空间的，建议不使用就去掉。
> 2. 格式化，一般公司都由自己格式化模版用来导入，如果没有也可以自己搞一个，并不复杂，通过Ctrl+Shilft+F就可以进行格式化选中的代码，让你写的代码按照你规定的风格模版排版。格式化可以避免你的代码不对齐，多空格，提高可阅读性。
> 3. 备注，写代码的时候，备注是不可或缺的部分，但是也要避免无用重复的备注，有些代码可能永远都不用了，但是写的很优秀，很多情况下舍不得删掉，就备注下了，导致占用大量行数，阅读的时候滚动条好长好长，既然优秀的代码就放到私人代码库中，没必要一直备注在哪里。
> 4. 避免无逻辑冗余代码，例如if(1==1)或者if(true)这样的逻辑，就不应该出现在代码里，但是我在工作的时候就遇到好几次这样的代码。
> 5. 合理运用空格，换行，来提高代码的阅读性，让你的代码更加优雅。
> 6. 慎用简写，除非一些公用的词，或者太长的词，非要使用的情况下尽量写好备注。
> 7. 尽量避免重复代码，同样功能的代码，就尽量想办法重用。
> 8. 拆分代码，我在工作中经常遇到一个类几万行代码，或者一个方法超过1000行，看起来非常头疼。
> 9. 尽量把同样作用或者同类型的代码写在一起，例如变量，常量都写在最前面，别让别人到处找。




###2.代码优化
**目的：**提高效率。

> 在上一家公司工作的时候，我们用的框架前后台交互用map，数据层每次取数据实体之后都要用一个工具类去转换成map，而我们数据层使用一个快捷开发的东西生成的，因此不管你的表有多少字段，都默认查询全部，也就意味着，你可能只需要一个字段，却查询出了所有字段，并且经过转换，又消耗了很多时间，而那些不使用的字段又占用了空间，当数据量过大的时候，弊端就出现了，查询一次等好几分钟，导出一次更慢，类似这样的情况很多，客户的要求会越来越严格，因此在保证功能OK的情况下，对代码进行适当的优化，有助于系统更加高效的运行。
> 代码优化的点也是比较多的，我经常用到的，例如对系统结构进行优化，对格式算法进行优化，对查询速度进行优化，因此我们今天就从这几点开始。
> 

**优化结构代码：**
> 优化结构一般用于维护旧系统的时候多一点，当我们到一个新的公司，可能第一件事是熟悉并维护尚在运行的系统或者其它人交接给你的系统，根据实际业务情况和代码进行分析，重构，提高代码运行的效率，修正不合理的模块，如果有必要的话，可能还需要重新设计 引入新的技术来解决问题。

**优化算法代码：**
>算法是一个比较抽象的东西，并不是所有人都可以的，但是费尽心思琢磨出一个更好的算法是，心中的激动也是难以言表的。
>举个例子来说明算法优化对系统的提升。

```
 package com.klsstt.test;

 /**
  * 累加算法实现<br>
  * 
  * @date 2016-07-05
  * @author klsstt
  * 
  */
 public class Test {

     //循环实现累加方法
     private static long cycle(long value) {
         long sum = 0;

         for (long i = 1,v = value; i <= v; i++) {
             sum += i;
         }
         return sum;
     }

     //高斯方法
     private static long gaosi(long value) {
         long sum = 0;
         sum = (value + 1) * value / 2;
         return sum;
     }

     public static void main(String[] args) {
         
         System.gc();//清理内存
         // you should change value,then get the different results
         long value = 10000000;
         long sum = 0;
         long start = System.currentTimeMillis();
         sum = cycle(value);
         long end = System.currentTimeMillis();
         System.out.println("循环累加方法从[1]到["+value+"]用时 ： ["+(end - start) + "]ms,结果："+ sum);
        
         System.gc(); //清理内存
         start = System.currentTimeMillis();
         sum = gaosi(value);
         end = System.currentTimeMillis();
         System.out.println("高斯方法从[1]到["+value+"]用时 ： ["+(end - start) + "]ms,结果："+ sum);

     }

 }

```
以上是一个累加算法的测试类，执行之后的结果如下：
循环累加方法从[1]到[10000000]用时 ： [24]ms,结果：50000005000000
高斯方法从[1]到[10000000]用时 ： [0]ms,结果：50000005000000
从结果中可以很明显的看到，更合适的算法对提高程序效率有很明细的改变。

**查询优化**：
> 这里不说数据库层面的优化，只说代码，不管什么系统，都离不开查询，查询的速度也决定了系统的强度，之前也说一个问题，就是类型转换的问题，当数据量大的时候，尽量避免过多的类型转换，尤其是用反射机制的实体类转map或者其它类型转换，多余的转换肯定是要需要耗费时间的，需要尽量避免。
> 然后就是循环语句，查询总是离不开各种循环，有时候需要嵌套使用，有时候需要在循环中判断各种业务，使用循环需要注意一下几点：
> 
> 1. 尽量在循环结构内避免与循环无关的变量:
> 
```
stratTime = System.nanoTime();  
for (int i = 0; i < 10000000; i++) {  
    i=i*a*b;  
}  
endTime = System.nanoTime();  
System.out.println("未提取耗时："+(endTime - stratTime));  
```
应改为：

```
stratTime = System.nanoTime();  
c = a*b;  
for (int i = 0; i < 10000000; i++) {  
    i=i*c;  
}  
endTime = System.nanoTime();  
System.out.println("已提取耗时："+(endTime - stratTime));  
```
> 两者耗时对比：
> 未提取耗时：45973050  
> 已提取耗时：1955  
> 2. 循环嵌套使用时，需要遵守“外小内大”的原则。
> 3. 尽量避免在循环中重复调用同样结果的方法，例如list.size()每次循环都会被执行一次，这无疑会影响程序的性能，所以应该将其放到循环外面，用一个变量来代替。
说完循环，我们继续回到查询优化上，这里的查询优化跟数据层无关，主要针对代码优化，常见的优化如下：
1.循环优化（刚说过）时，对链表遍历优先使用迭代器遍历或者for(T x: lst)，for(T x: lst)隐式地使用了迭代器来遍历链表。
2.变量优化，静态变量声明时，增加final static或者final修饰符，这样编译器就可以将它们内联并且在编译时就预先计算好它们的值。
3.避免冗长的分支语句（if-else-if），用switch-case替代。
4.避免频繁地通过+运算符进行字符串拼接（老生常谈），因为它会不断地生成新字符串对象，而生成字符串对象不仅耗时而且耗内存
5.避免频繁地对字符串对象调用substring和indexOf方法
6.避免在方法内部声明一个只包含常量的数组，应该把数组提为全局常量数组，这样可以避免每次方法调用都生成数组对象的时间开销。
7.被private final static修饰的方法运行更快
8.避免频繁调用LinkedList<T>或ArrayList<T>的remove(Object o)方法，它们会进行线性查找。
9.避免反射，通过反射创建对象、访问属性、调用方法比一般的创建对象、访问属性和调用方法要慢得多。

###3.性能调优

**目的：**提高程序的运行效率（并发，速度）。

> 首先要学会判断程序的性能，一般系统从这几个方面进行判断：
> 启动速度，执行速度，内存分配情况，负载承受能力。
> 根据程序的启动速度，查询速度，基本可以判断出程序快慢，根据内存分配的情况和负载能力基本可以判断程序的并发性的强弱，再举个本人的例子，在上家公司做项目的时候，项目上线测试的并发数是5，经过检查，发现查询速度非常慢，查询字段很多，内容很多，导致系统崩溃，于是每天加班加点的优化，从代码层到数据库，从每个逻辑，循环，到sql语句优化，索引等，最后才通过测试，但是熬夜真的很伤身体，也算是个教训吧，还有一次做一个政府项目，项目类型属于那种gps定位信息系统，有一张报警表，和行车轨迹表，每秒种都由几百条记录增加，光一张表就占了物理内存40G，每次查询跟它相关的报表速度就非常慢，像这种优化，从代码层面是无法得到解决了，必须从数据库层面解决，例如分表查询。

 **启动速度的优化**：
>1.查看部署应用系统的系统资源使用情况，CPU,内存，IO这几个方面去看。
2.使用jstack,jmap等命令查看是JVM是在在什么类型的内存空间中做GC（内存回收），和查看GC日志查看是那段代码在占用内存。
3.结构（设计），代码优化。

**执行速度的优化**：
>这里的执行速度包括增删改查，但是一般情况下，慢的都是查询，或者大批量的增加修改，主要有一下几点：
>1. 循环优化
>2. 对查询进行优化，要尽量避免全表扫描，首先应考虑在 where 及 order by 涉及的列上建立索引。
>3. 查询语句优化，尽量避免排序，模糊，分组查询等函数去查询大批量数据的表。
>4. 如果数据量过大，在程序设计阶段，需要考虑分表的情况。
>5. 适当的建立索引，能提示查询速度。
>6. 优化分页查询语句。

**内存分配情况的优化**：
> 
> 1. 别用new Boolean()
在很多场景中Boolean类型是必须的，比如JDBC中boolean类型的set与get都是通过Boolean封装传递的，大部分ORM也是用Boolean来封装boolean类型的
> 2. 别用new Integer
和Boolean类似，java开发中使用Integer封装int的场合也非常多，并且通常用int表示的数值通常都非常小。
> 3. 用StringBuffer代替字符串相加
> 4. 过滥使用哈希表
有一定开发经验的开发人员经常会使用hash表（hash表在JDK中的一个实现就是HashMap）来缓存一些数据，从而提高系统的运行速度。比如使用HashMap缓存一些物料信息、人员信息等基础资料，这在提高系统速度的同时也加大了系统的内存占用，特别是当缓存的资料比较多的时候。
> 5. 避免过深的类层次结构和过深的方法调用
因为这两者都是非常占用内存的（特别是方法调用更是堆栈空间的消耗大户）。
> 6. 变量只有在用到它的时候才定义和实例化。
> 7. 尽量避免使用static变量，类内私有常量可以用final来代替。 

**负载承受能力的优化**：
> 首先还是数据库，优化数据库是基础，然后从设计层面来说，静态化(效率最高、消耗最小的就是纯静态化的html页面)，高并发，高负责的网站可能还需要，增加图片服务器，增加缓存机制，物理上优化，增加唉服务器数量，cpu，内存，带宽之类的，进行分布式部署，集群，甚至私有云等等，需要考虑到的面比较广。
> 
